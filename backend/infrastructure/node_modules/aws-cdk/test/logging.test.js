"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const logging_1 = require("../lib/logging");
describe('logging', () => {
    // Mock streams to capture output
    let mockStdout;
    let mockStderr;
    beforeEach(() => {
        // Reset log level before each test
        (0, logging_1.setLogLevel)(logging_1.LogLevel.INFO);
        (0, logging_1.setCI)(false);
        // Create mock functions to capture output
        mockStdout = jest.fn();
        mockStderr = jest.fn();
        // Mock the write methods directly
        jest.spyOn(process.stdout, 'write').mockImplementation((chunk) => {
            mockStdout(chunk.toString());
            return true;
        });
        jest.spyOn(process.stderr, 'write').mockImplementation((chunk) => {
            mockStderr(chunk.toString());
            return true;
        });
    });
    afterEach(() => {
        jest.restoreAllMocks();
    });
    describe('stream selection', () => {
        test('data() always writes to stdout', () => {
            (0, logging_1.data)('test message');
            expect(mockStdout).toHaveBeenCalledWith(expect.stringContaining('test message\n'));
            expect(mockStderr).not.toHaveBeenCalled();
        });
        test('error() always writes to stderr', () => {
            (0, logging_1.error)('test error');
            expect(mockStderr).toHaveBeenCalledWith(expect.stringContaining('test error\n'));
            expect(mockStdout).not.toHaveBeenCalled();
        });
        test('print() writes to stderr by default', () => {
            (0, logging_1.print)('test print');
            expect(mockStderr).toHaveBeenCalledWith(expect.stringContaining('test print\n'));
            expect(mockStdout).not.toHaveBeenCalled();
        });
        test('print() writes to stdout in CI mode', () => {
            (0, logging_1.setCI)(true);
            (0, logging_1.print)('test print');
            expect(mockStdout).toHaveBeenCalledWith(expect.stringContaining('test print\n'));
            expect(mockStderr).not.toHaveBeenCalled();
        });
    });
    describe('log levels', () => {
        test('respects log level settings', () => {
            (0, logging_1.setLogLevel)(logging_1.LogLevel.ERROR);
            (0, logging_1.error)('error message');
            (0, logging_1.warning)('warning message');
            (0, logging_1.print)('print message');
            expect(mockStderr).toHaveBeenCalledWith(expect.stringContaining('error message\n'));
            expect(mockStderr).not.toHaveBeenCalledWith(expect.stringContaining('warning message\n'));
            expect(mockStderr).not.toHaveBeenCalledWith(expect.stringContaining('print message\n'));
        });
        test('debug messages only show at debug level', () => {
            (0, logging_1.setLogLevel)(logging_1.LogLevel.INFO);
            (0, logging_1.debug)('debug message');
            expect(mockStderr).not.toHaveBeenCalled();
            (0, logging_1.setLogLevel)(logging_1.LogLevel.DEBUG);
            (0, logging_1.debug)('debug message');
            expect(mockStderr).toHaveBeenCalledWith(expect.stringContaining('debug message\n'));
        });
        test('trace messages only show at trace level', () => {
            (0, logging_1.setLogLevel)(logging_1.LogLevel.DEBUG);
            (0, logging_1.trace)('trace message');
            expect(mockStderr).not.toHaveBeenCalled();
            (0, logging_1.setLogLevel)(logging_1.LogLevel.TRACE);
            (0, logging_1.trace)('trace message');
            expect(mockStderr).toHaveBeenCalledWith(expect.stringContaining('trace message\n'));
        });
    });
    describe('message formatting', () => {
        test('formats messages with multiple arguments', () => {
            (0, logging_1.print)('Value: %d, String: %s', 42, 'test');
            expect(mockStderr).toHaveBeenCalledWith(expect.stringContaining('Value: 42, String: test\n'));
        });
        test('handles prefix correctly', () => {
            const prefixedLog = (0, logging_1.prefix)('PREFIX');
            prefixedLog('test message');
            expect(mockStderr).toHaveBeenCalledWith(expect.stringContaining('PREFIX test message\n'));
        });
        test('handles custom styles', () => {
            (0, logging_1.success)('success message');
            // Note: actual styling will depend on chalk, but we can verify the message is there
            expect(mockStderr).toHaveBeenCalledWith(expect.stringContaining('success message\n'));
        });
    });
    describe('corked logging', () => {
        test('buffers messages when corked', async () => {
            await (0, logging_1.withCorkedLogging)(async () => {
                (0, logging_1.print)('message 1');
                (0, logging_1.print)('message 2');
                expect(mockStderr).not.toHaveBeenCalled();
            });
            expect(mockStderr).toHaveBeenCalledWith(expect.stringContaining('message 1\n'));
            expect(mockStderr).toHaveBeenCalledWith(expect.stringContaining('message 2\n'));
        });
        test('handles nested corking correctly', async () => {
            await (0, logging_1.withCorkedLogging)(async () => {
                (0, logging_1.print)('outer 1');
                await (0, logging_1.withCorkedLogging)(async () => {
                    (0, logging_1.print)('inner');
                });
                (0, logging_1.print)('outer 2');
                expect(mockStderr).not.toHaveBeenCalled();
            });
            expect(mockStderr).toHaveBeenCalledTimes(3);
            expect(mockStderr).toHaveBeenCalledWith(expect.stringContaining('outer 1\n'));
            expect(mockStderr).toHaveBeenCalledWith(expect.stringContaining('inner\n'));
            expect(mockStderr).toHaveBeenCalledWith(expect.stringContaining('outer 2\n'));
        });
    });
    describe('timestamp and prefix handling', () => {
        test('combines timestamp and prefix correctly', () => {
            (0, logging_1.log)({
                level: logging_1.LogLevel.INFO,
                message: 'test message',
                timestamp: true,
                prefix: 'PREFIX',
            });
            expect(mockStderr).toHaveBeenCalledWith(expect.stringMatching(/PREFIX \[\d{2}:\d{2}:\d{2}\] test message\n/));
        });
    });
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibG9nZ2luZy50ZXN0LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsibG9nZ2luZy50ZXN0LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsNENBQWtKO0FBRWxKLFFBQVEsQ0FBQyxTQUFTLEVBQUUsR0FBRyxFQUFFO0lBQ3ZCLGlDQUFpQztJQUNqQyxJQUFJLFVBQXFCLENBQUM7SUFDMUIsSUFBSSxVQUFxQixDQUFDO0lBRTFCLFVBQVUsQ0FBQyxHQUFHLEVBQUU7UUFDZCxtQ0FBbUM7UUFDbkMsSUFBQSxxQkFBVyxFQUFDLGtCQUFRLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDM0IsSUFBQSxlQUFLLEVBQUMsS0FBSyxDQUFDLENBQUM7UUFFYiwwQ0FBMEM7UUFDMUMsVUFBVSxHQUFHLElBQUksQ0FBQyxFQUFFLEVBQUUsQ0FBQztRQUN2QixVQUFVLEdBQUcsSUFBSSxDQUFDLEVBQUUsRUFBRSxDQUFDO1FBRXZCLGtDQUFrQztRQUNsQyxJQUFJLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxNQUFNLEVBQUUsT0FBTyxDQUFDLENBQUMsa0JBQWtCLENBQUMsQ0FBQyxLQUFVLEVBQUUsRUFBRTtZQUNwRSxVQUFVLENBQUMsS0FBSyxDQUFDLFFBQVEsRUFBRSxDQUFDLENBQUM7WUFDN0IsT0FBTyxJQUFJLENBQUM7UUFDZCxDQUFDLENBQUMsQ0FBQztRQUVILElBQUksQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLE1BQU0sRUFBRSxPQUFPLENBQUMsQ0FBQyxrQkFBa0IsQ0FBQyxDQUFDLEtBQVUsRUFBRSxFQUFFO1lBQ3BFLFVBQVUsQ0FBQyxLQUFLLENBQUMsUUFBUSxFQUFFLENBQUMsQ0FBQztZQUM3QixPQUFPLElBQUksQ0FBQztRQUNkLENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQyxDQUFDLENBQUM7SUFFSCxTQUFTLENBQUMsR0FBRyxFQUFFO1FBQ2IsSUFBSSxDQUFDLGVBQWUsRUFBRSxDQUFDO0lBQ3pCLENBQUMsQ0FBQyxDQUFDO0lB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QUNMLENBQUMsQ0FBQyxDQUFDO0FBQ0wsQ0FBQyxDQUFDLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBMb2dMZXZlbCwgbG9nLCBzZXRMb2dMZXZlbCwgc2V0Q0ksIGRhdGEsIHByaW50LCBlcnJvciwgd2FybmluZywgc3VjY2VzcywgZGVidWcsIHRyYWNlLCBwcmVmaXgsIHdpdGhDb3JrZWRMb2dnaW5nIH0gZnJvbSAnLi4vbGliL2xvZ2dpbmcnO1xuXG5kZXNjcmliZSgnbG9nZ2luZycsICgpID0+IHtcbiAgLy8gTW9jayBzdHJlYW1zIHRvIGNhcHR1cmUgb3V0cHV0XG4gIGxldCBtb2NrU3Rkb3V0OiBqZXN0Lk1vY2s7XG4gIGxldCBtb2NrU3RkZXJyOiBqZXN0Lk1vY2s7XG5cbiAgYmVmb3JlRWFjaCgoKSA9PiB7XG4gICAgLy8gUmVzZXQgbG9nIGxldmVsIGJlZm9yZSBlYWNoIHRlc3RcbiAgICBzZXRMb2dMZXZlbChMb2dMZXZlbC5JTkZPKTtcbiAgICBzZXRDSShmYWxzZSk7XG5cbiAgICAvLyBDcmVhdGUgbW9jayBmdW5jdGlvbnMgdG8gY2FwdHVyZSBvdXRwdXRcbiAgICBtb2NrU3Rkb3V0ID0gamVzdC5mbigpO1xuICAgIG1vY2tTdGRlcnIgPSBqZXN0LmZuKCk7XG5cbiAgICAvLyBNb2NrIHRoZSB3cml0ZSBtZXRob2RzIGRpcmVjdGx5XG4gICAgamVzdC5zcHlPbihwcm9jZXNzLnN0ZG91dCwgJ3dyaXRlJykubW9ja0ltcGxlbWVudGF0aW9uKChjaHVuazogYW55KSA9PiB7XG4gICAgICBtb2NrU3Rkb3V0KGNodW5rLnRvU3RyaW5nKCkpO1xuICAgICAgcmV0dXJuIHRydWU7XG4gICAgfSk7XG5cbiAgICBqZXN0LnNweU9uKHByb2Nlc3Muc3RkZXJyLCAnd3JpdGUnKS5tb2NrSW1wbGVtZW50YXRpb24oKGNodW5rOiBhbnkpID0+IHtcbiAgICAgIG1vY2tTdGRlcnIoY2h1bmsudG9TdHJpbmcoKSk7XG4gICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9KTtcbiAgfSk7XG5cbiAgYWZ0ZXJFYWNoKCgpID0+IHtcbiAgICBqZXN0LnJlc3RvcmVBbGxNb2NrcygpO1xuICB9KTtcbiAgZGVzY3JpYmUoJ3N0cmVhbSBzZWxlY3Rpb24nLCAoKSA9PiB7XG4gICAgdGVzdCgnZGF0YSgpIGFsd2F5cyB3cml0ZXMgdG8gc3Rkb3V0JywgKCkgPT4ge1xuICAgICAgZGF0YSgndGVzdCBtZXNzYWdlJyk7XG4gICAgICBleHBlY3QobW9ja1N0ZG91dCkudG9IYXZlQmVlbkNhbGxlZFdpdGgoZXhwZWN0LnN0cmluZ0NvbnRhaW5pbmcoJ3Rlc3QgbWVzc2FnZVxcbicpKTtcbiAgICAgIGV4cGVjdChtb2NrU3RkZXJyKS5ub3QudG9IYXZlQmVlbkNhbGxlZCgpO1xuICAgIH0pO1xuXG4gICAgdGVzdCgnZXJyb3IoKSBhbHdheXMgd3JpdGVzIHRvIHN0ZGVycicsICgpID0+IHtcbiAgICAgIGVycm9yKCd0ZXN0IGVycm9yJyk7XG4gICAgICBleHBlY3QobW9ja1N0ZGVycikudG9IYXZlQmVlbkNhbGxlZFdpdGgoZXhwZWN0LnN0cmluZ0NvbnRhaW5pbmcoJ3Rlc3QgZXJyb3JcXG4nKSk7XG4gICAgICBleHBlY3QobW9ja1N0ZG91dCkubm90LnRvSGF2ZUJlZW5DYWxsZWQoKTtcbiAgICB9KTtcblxuICAgIHRlc3QoJ3ByaW50KCkgd3JpdGVzIHRvIHN0ZGVyciBieSBkZWZhdWx0JywgKCkgPT4ge1xuICAgICAgcHJpbnQoJ3Rlc3QgcHJpbnQnKTtcbiAgICAgIGV4cGVjdChtb2NrU3RkZXJyKS50b0hhdmVCZWVuQ2FsbGVkV2l0aChleHBlY3Quc3RyaW5nQ29udGFpbmluZygndGVzdCBwcmludFxcbicpKTtcbiAgICAgIGV4cGVjdChtb2NrU3Rkb3V0KS5ub3QudG9IYXZlQmVlbkNhbGxlZCgpO1xuICAgIH0pO1xuXG4gICAgdGVzdCgncHJpbnQoKSB3cml0ZXMgdG8gc3Rkb3V0IGluIENJIG1vZGUnLCAoKSA9PiB7XG4gICAgICBzZXRDSSh0cnVlKTtcbiAgICAgIHByaW50KCd0ZXN0IHByaW50Jyk7XG4gICAgICBleHBlY3QobW9ja1N0ZG91dCkudG9IYXZlQmVlbkNhbGxlZFdpdGgoZXhwZWN0LnN0cmluZ0NvbnRhaW5pbmcoJ3Rlc3QgcHJpbnRcXG4nKSk7XG4gICAgICBleHBlY3QobW9ja1N0ZGVycikubm90LnRvSGF2ZUJlZW5DYWxsZWQoKTtcbiAgICB9KTtcbiAgfSk7XG5cbiAgZGVzY3JpYmUoJ2xvZyBsZXZlbHMnLCAoKSA9PiB7XG4gICAgdGVzdCgncmVzcGVjdHMgbG9nIGxldmVsIHNldHRpbmdzJywgKCkgPT4ge1xuICAgICAgc2V0TG9nTGV2ZWwoTG9nTGV2ZWwuRVJST1IpO1xuICAgICAgZXJyb3IoJ2Vycm9yIG1lc3NhZ2UnKTtcbiAgICAgIHdhcm5pbmcoJ3dhcm5pbmcgbWVzc2FnZScpO1xuICAgICAgcHJpbnQoJ3ByaW50IG1lc3NhZ2UnKTtcbiAgICAgIGV4cGVjdChtb2NrU3RkZXJyKS50b0hhdmVCZWVuQ2FsbGVkV2l0aChleHBlY3Quc3RyaW5nQ29udGFpbmluZygnZXJyb3IgbWVzc2FnZVxcbicpKTtcbiAgICAgIGV4cGVjdChtb2NrU3RkZXJyKS5ub3QudG9IYXZlQmVlbkNhbGxlZFdpdGgoZXhwZWN0LnN0cmluZ0NvbnRhaW5pbmcoJ3dhcm5pbmcgbWVzc2FnZVxcbicpKTtcbiAgICAgIGV4cGVjdChtb2NrU3RkZXJyKS5ub3QudG9IYXZlQmVlbkNhbGxlZFdpdGgoZXhwZWN0LnN0cmluZ0NvbnRhaW5pbmcoJ3ByaW50IG1lc3NhZ2VcXG4nKSk7XG4gICAgfSk7XG5cbiAgICB0ZXN0KCdkZWJ1ZyBtZXNzYWdlcyBvbmx5IHNob3cgYXQgZGVidWcgbGV2ZWwnLCAoKSA9PiB7XG4gICAgICBzZXRMb2dMZXZlbChMb2dMZXZlbC5JTkZPKTtcbiAgICAgIGRlYnVnKCdkZWJ1ZyBtZXNzYWdlJyk7XG4gICAgICBleHBlY3QobW9ja1N0ZGVycikubm90LnRvSGF2ZUJlZW5DYWxsZWQoKTtcblxuICAgICAgc2V0TG9nTGV2ZWwoTG9nTGV2ZWwuREVCVUcpO1xuICAgICAgZGVidWcoJ2RlYnVnIG1lc3NhZ2UnKTtcbiAgICAgIGV4cGVjdChtb2NrU3RkZXJyKS50b0hhdmVCZWVuQ2FsbGVkV2l0aChleHBlY3Quc3RyaW5nQ29udGFpbmluZygnZGVidWcgbWVzc2FnZVxcbicpKTtcbiAgICB9KTtcblxuICAgIHRlc3QoJ3RyYWNlIG1lc3NhZ2VzIG9ubHkgc2hvdyBhdCB0cmFjZSBsZXZlbCcsICgpID0+IHtcbiAgICAgIHNldExvZ0xldmVsKExvZ0xldmVsLkRFQlVHKTtcbiAgICAgIHRyYWNlKCd0cmFjZSBtZXNzYWdlJyk7XG4gICAgICBleHBlY3QobW9ja1N0ZGVycikubm90LnRvSGF2ZUJlZW5DYWxsZWQoKTtcblxuICAgICAgc2V0TG9nTGV2ZWwoTG9nTGV2ZWwuVFJBQ0UpO1xuICAgICAgdHJhY2UoJ3RyYWNlIG1lc3NhZ2UnKTtcbiAgICAgIGV4cGVjdChtb2NrU3RkZXJyKS50b0hhdmVCZWVuQ2FsbGVkV2l0aChleHBlY3Quc3RyaW5nQ29udGFpbmluZygndHJhY2UgbWVzc2FnZVxcbicpKTtcbiAgICB9KTtcbiAgfSk7XG5cbiAgZGVzY3JpYmUoJ21lc3NhZ2UgZm9ybWF0dGluZycsICgpID0+IHtcbiAgICB0ZXN0KCdmb3JtYXRzIG1lc3NhZ2VzIHdpdGggbXVsdGlwbGUgYXJndW1lbnRzJywgKCkgPT4ge1xuICAgICAgcHJpbnQoJ1ZhbHVlOiAlZCwgU3RyaW5nOiAlcycsIDQyLCAndGVzdCcpO1xuICAgICAgZXhwZWN0KG1vY2tTdGRlcnIpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKGV4cGVjdC5zdHJpbmdDb250YWluaW5nKCdWYWx1ZTogNDIsIFN0cmluZzogdGVzdFxcbicpKTtcbiAgICB9KTtcblxuICAgIHRlc3QoJ2hhbmRsZXMgcHJlZml4IGNvcnJlY3RseScsICgpID0+IHtcbiAgICAgIGNvbnN0IHByZWZpeGVkTG9nID0gcHJlZml4KCdQUkVGSVgnKTtcbiAgICAgIHByZWZpeGVkTG9nKCd0ZXN0IG1lc3NhZ2UnKTtcbiAgICAgIGV4cGVjdChtb2NrU3RkZXJyKS50b0hhdmVCZWVuQ2FsbGVkV2l0aChleHBlY3Quc3RyaW5nQ29udGFpbmluZygnUFJFRklYIHRlc3QgbWVzc2FnZVxcbicpKTtcbiAgICB9KTtcblxuICAgIHRlc3QoJ2hhbmRsZXMgY3VzdG9tIHN0eWxlcycsICgpID0+IHtcbiAgICAgIHN1Y2Nlc3MoJ3N1Y2Nlc3MgbWVzc2FnZScpO1xuICAgICAgLy8gTm90ZTogYWN0dWFsIHN0eWxpbmcgd2lsbCBkZXBlbmQgb24gY2hhbGssIGJ1dCB3ZSBjYW4gdmVyaWZ5IHRoZSBtZXNzYWdlIGlzIHRoZXJlXG4gICAgICBleHBlY3QobW9ja1N0ZGVycikudG9IYXZlQmVlbkNhbGxlZFdpdGgoZXhwZWN0LnN0cmluZ0NvbnRhaW5pbmcoJ3N1Y2Nlc3MgbWVzc2FnZVxcbicpKTtcbiAgICB9KTtcbiAgfSk7XG5cbiAgZGVzY3JpYmUoJ2NvcmtlZCBsb2dnaW5nJywgKCkgPT4ge1xuICAgIHRlc3QoJ2J1ZmZlcnMgbWVzc2FnZXMgd2hlbiBjb3JrZWQnLCBhc3luYyAoKSA9PiB7XG4gICAgICBhd2FpdCB3aXRoQ29ya2VkTG9nZ2luZyhhc3luYyAoKSA9PiB7XG4gICAgICAgIHByaW50KCdtZXNzYWdlIDEnKTtcbiAgICAgICAgcHJpbnQoJ21lc3NhZ2UgMicpO1xuICAgICAgICBleHBlY3QobW9ja1N0ZGVycikubm90LnRvSGF2ZUJlZW5DYWxsZWQoKTtcbiAgICAgIH0pO1xuXG4gICAgICBleHBlY3QobW9ja1N0ZGVycikudG9IYXZlQmVlbkNhbGxlZFdpdGgoZXhwZWN0LnN0cmluZ0NvbnRhaW5pbmcoJ21lc3NhZ2UgMVxcbicpKTtcbiAgICAgIGV4cGVjdChtb2NrU3RkZXJyKS50b0hhdmVCZWVuQ2FsbGVkV2l0aChleHBlY3Quc3RyaW5nQ29udGFpbmluZygnbWVzc2FnZSAyXFxuJykpO1xuICAgIH0pO1xuXG4gICAgdGVzdCgnaGFuZGxlcyBuZXN0ZWQgY29ya2luZyBjb3JyZWN0bHknLCBhc3luYyAoKSA9PiB7XG4gICAgICBhd2FpdCB3aXRoQ29ya2VkTG9nZ2luZyhhc3luYyAoKSA9PiB7XG4gICAgICAgIHByaW50KCdvdXRlciAxJyk7XG4gICAgICAgIGF3YWl0IHdpdGhDb3JrZWRMb2dnaW5nKGFzeW5jICgpID0+IHtcbiAgICAgICAgICBwcmludCgnaW5uZXInKTtcbiAgICAgICAgfSk7XG4gICAgICAgIHByaW50KCdvdXRlciAyJyk7XG4gICAgICAgIGV4cGVjdChtb2NrU3RkZXJyKS5ub3QudG9IYXZlQmVlbkNhbGxlZCgpO1xuICAgICAgfSk7XG5cbiAgICAgIGV4cGVjdChtb2NrU3RkZXJyKS50b0hhdmVCZWVuQ2FsbGVkVGltZXMoMyk7XG4gICAgICBleHBlY3QobW9ja1N0ZGVycikudG9IYXZlQmVlbkNhbGxlZFdpdGgoZXhwZWN0LnN0cmluZ0NvbnRhaW5pbmcoJ291dGVyIDFcXG4nKSk7XG4gICAgICBleHBlY3QobW9ja1N0ZGVycikudG9IYXZlQmVlbkNhbGxlZFdpdGgoZXhwZWN0LnN0cmluZ0NvbnRhaW5pbmcoJ2lubmVyXFxuJykpO1xuICAgICAgZXhwZWN0KG1vY2tTdGRlcnIpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKGV4cGVjdC5zdHJpbmdDb250YWluaW5nKCdvdXRlciAyXFxuJykpO1xuICAgIH0pO1xuICB9KTtcblxuICBkZXNjcmliZSgndGltZXN0YW1wIGFuZCBwcmVmaXggaGFuZGxpbmcnLCAoKSA9PiB7XG4gICAgdGVzdCgnY29tYmluZXMgdGltZXN0YW1wIGFuZCBwcmVmaXggY29ycmVjdGx5JywgKCkgPT4ge1xuICAgICAgbG9nKHtcbiAgICAgICAgbGV2ZWw6IExvZ0xldmVsLklORk8sXG4gICAgICAgIG1lc3NhZ2U6ICd0ZXN0IG1lc3NhZ2UnLFxuICAgICAgICB0aW1lc3RhbXA6IHRydWUsXG4gICAgICAgIHByZWZpeDogJ1BSRUZJWCcsXG4gICAgICB9KTtcbiAgICAgIGV4cGVjdChtb2NrU3RkZXJyKS50b0hhdmVCZWVuQ2FsbGVkV2l0aChcbiAgICAgICAgZXhwZWN0LnN0cmluZ01hdGNoaW5nKC9QUkVGSVggXFxbXFxkezJ9OlxcZHsyfTpcXGR7Mn1cXF0gdGVzdCBtZXNzYWdlXFxuLyksXG4gICAgICApO1xuICAgIH0pO1xuICB9KTtcbn0pO1xuIl19